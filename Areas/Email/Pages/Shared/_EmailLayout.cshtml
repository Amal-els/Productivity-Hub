@using Microsoft.AspNetCore.Identity
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "The DAG Hub";
    var currentTab = ViewData["CurrentTab"]?.ToString() ?? "Email";
}
<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>@ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        .body * {
            transform: none;
        }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
            animation: fadeIn 0.5s ease-out;
        }
        .email-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 32px 40px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .logout-btn {
            width: 50px !important;
            height: 50px !important;
            border-radius: 50% !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            border: none !important;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            cursor: pointer;
        }

            .logout-btn:hover {
                transform: translateY(-2px) !important;
                box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4) !important;
            }

            .logout-btn:active {
                transform: translateY(0) !important;
            }

            .logout-btn svg {
                width: 24px !important;
                height: 24px !important;
                flex-shrink: 0;
            }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .tab-navigation {
            display: flex;
            padding: 16px 24px 0 24px;
            gap: 8px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            overflow-x: auto;
            scrollbar-width: none;
        }

        .tab-navigation::-webkit-scrollbar {
            display: none;
        }

        .tab-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 24px;
            text-decoration: none;
            color: #64748b;
            font-size: 15px;
            font-weight: 500;
            border-radius: 12px 12px 0 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            white-space: nowrap;
            border: 2px solid transparent;
            border-bottom: none;
        }

        .tab-link::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 80%;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px 2px 0 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-link:hover {
            color: #334155;
            background: rgba(102, 126, 234, 0.05);
        }

        .tab-link.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.08);
            font-weight: 600;
        }

        .tab-link.active::before {
            transform: translateX(-50%) scaleX(1);
        }

        .tab-icon {
            width: 20px;
            height: 20px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-link:hover .tab-icon {
            transform: scale(1.1);
        }

        .tab-link.active .tab-icon {
            animation: iconPop 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @@keyframes iconPop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .content-area {
            padding: 40px;
            min-height: 600px;
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @@keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Floating particles background effect */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 15s infinite;
        }

        .particle:nth-child(1) { left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 20%; animation-delay: 2s; }
        .particle:nth-child(3) { left: 30%; animation-delay: 4s; }
        .particle:nth-child(4) { left: 40%; animation-delay: 1s; }
        .particle:nth-child(5) { left: 50%; animation-delay: 3s; }
        .particle:nth-child(6) { left: 60%; animation-delay: 5s; }
        .particle:nth-child(7) { left: 70%; animation-delay: 2s; }
        .particle:nth-child(8) { left: 80%; animation-delay: 4s; }
        .particle:nth-child(9) { left: 90%; animation-delay: 1s; }

        @@keyframes float {
            0%, 100% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3, #6a4093);
        }

        .email-layout-container {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        /* Sidebar Column */
        .sidebar-column {
            flex: 0 0 280px;
            min-width: 280px;
        }

        /* Main Content Column */
        .main-content-column {
            flex: 1;
            min-width: 0;
        }

        /* Modal Fix */
        .modal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 1050 !important;
        }

        .modal-backdrop {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 1040 !important;
            width: 100vw !important;
            height: 100vh !important;
        }

        .modal-dialog {
            z-index: 1055 !important;
        }

        /* Responsive */
        @@media (max-width: 768px) {
            .app-container {
                padding: 16px;
            }

            .header {
                padding: 24px;
            }

            .header h1 {
                font-size: 24px;
            }

            .tab-link {
                padding: 12px 16px;
                font-size: 14px;
            }

            .content-area {
                padding: 24px;
            }

            .email-layout-container {
                flex-direction: column;
                gap: 20px;
            }

            .sidebar-column {
                flex: 1;
                min-width: 100%;
            }
            #vapi-btn,
            [id^="vapi"],
            .vapi-widget,
            .vapi-button {
                position: fixed !important;
                bottom: 40px !important;
                right: 40px !important;
                z-index: 9999 !important;
        }}
    </style>
</head>
<body>
    <div class="particles">
         @for (int i = 0; i < 9; i++)
        {
            <div class="particle"></div>
        }
    </div>

    <div class="app-container">
        <div class="header d-flex align-items-center justify-content-between position-relative">
            <h1>‚ú® The DAG Hub</h1>
        
            <!-- Right side: Settings + Logout -->
            <div class="header-actions d-flex gap-2">
                <!-- Logout Button -->
                 <form method="post" asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Page("/Account/Login", new { area = "Identity" })">
                <button type="submit" class="logout-btn" title="Logout">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z" />
                        <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.647 2.646a.5.5 0 0 0 .708.708l3-3z" />
                    </svg>
                </button>
            </form>
            </div>
        </div>
       
        </div>

        <div class="main-card">
           
            <nav class="tab-navigation d-flex align-items-center justify-content-between">
                
                <a href="@Url.Action("Index", "Home")" class="tab-link @(currentTab == "Dashboard" ? "active" : "")">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8v-10h-8v10zm0-18v6h8V3h-8z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Dashboard
                </a>
                <a href="@Url.Action("Index", "Calendar")" class="tab-link @(currentTab == "Calendar" ? "active" : "")">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <line x1="16" y1="2" x2="16" y2="6" stroke-width="2" stroke-linecap="round" />
                        <line x1="8" y1="2" x2="8" y2="6" stroke-width="2" stroke-linecap="round" />
                        <line x1="3" y1="10" x2="21" y2="10" stroke-width="2" stroke-linecap="round" />
                    </svg>
                    Calendar
                </a>

                <a href="@Url.Action("Index", "ToDo")" class="tab-link @(currentTab == "ToDo" ? "active" : "")">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M9 11l3 3L22 4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    To-Do
                </a>

                <a href="@Url.Action("Index", "Email")" class="tab-link @(currentTab == "Email" ? "active" : "")">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <polyline points="22,6 12,13 2,6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    Email
                </a>

                <a href="@Url.Action("Index", "Pomodoro")" class="tab-link @(currentTab == "Pomodoro" ? "active" : "")">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <polyline points="12,6 12,12 16,14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    Pomodoro
                </a>

                <a href="@Url.Action("Index", "Meetings")" class="tab-link @(currentTab == "Meetings" ? "active" : "")">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <circle cx="9" cy="7" r="4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    Meetings
                </a>

                <a href="@Url.Action("Index", "Notes")" class="tab-link @(currentTab == "Notes" ? "active" : "")">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <polyline points="14,2 14,8 20,8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <line x1="16" y1="13" x2="8" y2="13" stroke-width="2" stroke-linecap="round" />
                        <line x1="16" y1="17" x2="8" y2="17" stroke-width="2" stroke-linecap="round" />
                        <polyline points="10,9 9,9 8,9" stroke-width="2" stroke-linecap="round" />
                    </svg>
                    Notes
                </a>

                <a href="@Url.Action("Index", "Assistant")" class="tab-link @(currentTab == "Assistant" ? "active" : "")">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    Assistant
                </a>
                
            </nav>
            
            <div class="content-area">
    <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 1rem; margin-top: 10px;">
        <h2 class="email-title" style="margin: 0;">Email</h2>
    </div>
    
    <!-- NEW LAYOUT STRUCTURE -->
    <div class="email-layout-container">
                    <!-- Sidebar Column -->
                    <div class="sidebar-column">
                        @await Html.PartialAsync("_EmailSidebar")
                    </div>
                    
                    <!-- Main Content Column -->
                    <div class="main-content-column">
                        @RenderBody()
                    </div>
                </div>
            </div>
        </div>
  
          
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- VAPI Widget Configuration -->
    <script>
        window.VAPI_CONFIG = {
            publicKey: '@Configuration["VapiSettings:PublicKey"]',
            assistantId: '@Configuration["VapiSettings:AssistantId"]'
        };
    </script>

    <!-- VAPI Widget Script -->
<script>
(function() {
    'use strict';

    const buttonConfig = {
        position: "bottom-right",
        offset: "40px",
        width: "50px",
        height: "50px",
        idle: {
            color: "#667eea",
            type: "pill",
            title: "Send Email with Voice",
            subtitle: "Talk to compose emails",
            icon: "https://unpkg.com/lucide-static@0.321.0/icons/mail.svg",
        },
        loading: {
            color: "rgb(93, 124, 202)",
            type: "pill",
            title: "Connecting...",
            subtitle: "Please wait",
            icon: "https://unpkg.com/lucide-static@0.321.0/icons/loader-2.svg",
        },
        active: {
            color: "rgb(255, 0, 0)",
            type: "pill",
            title: "Listening...",
            subtitle: "Speak now",
            icon: "https://unpkg.com/lucide-static@0.321.0/icons/mic.svg",
        },
    };

    function initializeVapi() {
        if (typeof window.vapiSDK !== 'undefined') {
            try {
                if (!window.VAPI_CONFIG || !window.VAPI_CONFIG.publicKey) {
                    console.error('‚ùå VAPI configuration missing');
                    return;
                }

                const userEmail = '@User.Identity.Name';
                const userId = '@UserManager.GetUserId(User)';
                
                if (!userEmail) {
                    console.error('‚ùå User not logged in');
                    return;
                }

                // Construire l'URL avec les param√®tres utilisateur
                const webhookUrl = `https://amal96.app.n8n.cloud/webhook-test/voice-email?userEmail=${encodeURIComponent(userEmail)}&userId=${encodeURIComponent(userId)}`;

                console.log('üöÄ Initializing VAPI...');
                console.log('üìß User Email:', userEmail);
                console.log('üÜî User ID:', userId);
                console.log('üì° Webhook URL:', webhookUrl);

                // ‚≠ê UTILISER ASSISTANT OVERRIDES AU LIEU DE assistantId !
                const vapi = window.vapiSDK.run({
                    apiKey: window.VAPI_CONFIG.publicKey,
                    // NE PAS utiliser assistantId, mais assistant avec overrides
                    assistant: {
                        // Copier toute la config de ton assistant depuis le dashboard
                        firstMessage: "Hello, this is Mel, your email assistant from The DAG Hub. How can I assist you today?",
                        model: {
                            provider: "openai",
                            model: "gpt-4o",
                            messages: [
                                {
                                    role: "system",
                                    content: "You are a friendly and funny personal assistant who loves helping the user with tasks in an upbeat and approachable way. Your role is to assist the user with sending emails. When the user provides details like who the email is for and what it's about, you will pass that information to the sendEmail tool and wait for its response. Once you get confirmation that the email was sent, cheerfully let the user know it's done and ask if there's anything else you can help with. Keep your tone light, friendly, and witty while remaining efficient and clear in your responses."
                                }
                            ],
                            tools: [
                                {
                                    type: "function",
                                    function: {
                                        name: "sendEmail",
                                        description: "Send an email based on user voice instructions",
                                        parameters: {
                                            type: "object",
                                            required: ["to", "emailSubject"],
                                            properties: {
                                                to: {
                                                    type: "string",
                                                    description: "The recipient's name"
                                                },
                                                emailSubject: {
                                                    type: "string",
                                                    description: "The email subject"
                                                }
                                            }
                                        }
                                    },
                                    // ‚≠ê ICI ON PEUT METTRE LE serverUrl DYNAMIQUE !
                                    server: {
                                        url: webhookUrl,
                                        timeoutSeconds: 20
                                    }
                                }
                            ]
                        },
                        voice: {
                            provider: "vapi",
                            voiceId: "Tara"
                        },
                        transcriber: {
                            provider: "deepgram",
                            model: "flux-general-en",
                            language: "en"
                        }
                    },
                    config: buttonConfig
                });
                
                console.log('‚úÖ VAPI initialized successfully');
                
                // Logger les √©v√©nements
                if (vapi && typeof vapi.on === 'function') {
                    vapi.on('call-start', (event) => {
                        console.log('üìû Call started');
                    });
                    
                    vapi.on('speech-start', () => {
                        console.log('üéôÔ∏è User started speaking');
                    });
                    
                    vapi.on('message', (msg) => {
                        console.log('üí¨ Message:', msg);
                    });
                    
                    vapi.on('call-end', () => {
                        console.log('üìû Call ended');
                    });
                    
                    vapi.on('error', (error) => {
                        console.error('‚ùå VAPI Error:', error);
                    });
                }
                
                // Positionner le bouton VAPI
                setTimeout(() => {
                    const vapiBtn = document.querySelector('[id^="vapi"]') || document.querySelector('.vapi-button');
                    if (vapiBtn) {
                        vapiBtn.style.position = 'fixed';
                        vapiBtn.style.bottom = '40px';
                        vapiBtn.style.right = '40px';
                        vapiBtn.style.zIndex = '9999';
                        console.log('‚úÖ VAPI button positioned');
                    }
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Error initializing VAPI:', error);
            }
        }
    }

    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/gh/VapiAI/html-script-tag@latest/dist/assets/index.js';
    script.async = true;
    script.onload = initializeVapi;
    script.onerror = function() {
        console.error('‚ùå Failed to load VAPI SDK');
    };
    
    document.head.appendChild(script);
})();
</script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>