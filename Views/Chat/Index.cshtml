@{
    ViewData["Title"] = "Productivity Assistant";
}

@Html.AntiForgeryToken()

<div class="chat-wrapper">
    <!-- Header -->
    <div class="chat-header">
        <div class="chat-header-avatar">
            <i class="bi bi-robot"></i>
        </div>
        <div class="chat-header-info">
            <h5>The DAG HUB  Assistant</h5>
            <span>Always here to help you become more productive</span>
        </div>
    </div>

    <!-- Messages Area -->
    <div class="chat-box" id="chatBox">
        <!-- Message de bienvenue initial -->
        <div class="message-row bot-row">
            <div class="message-avatar bot-avatar">
                <i class="bi bi-robot"></i>
            </div>
            <div class="message-bubble-wrapper">
                <div class="message-bubble bot-bubble">
                    Hi! I'm your productivity assistant. I can help you with tasks, meetings, notes, and time management. How can I assist you today?
                </div>
                <span class="message-time" id="initTime"></span>
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="chat-input-area">
        <input type="text"
               id="chatInput"
               class="chat-input"
               placeholder="Type your message..." />
        <button id="sendBtn" class="chat-send-btn">
            <i class="bi bi-send-fill"></i> Send
        </button>
    </div>
</div>

@section Scripts {
<script>
    const chatBox = document.getElementById("chatBox");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");

    // Heure initiale du message de bienvenue
    document.getElementById('initTime').textContent = getCurrentTime();

    function getCurrentTime() {
        return new Date().toTimeString().substring(0, 8);
    }

    sendBtn.addEventListener("click", async () => {
        const message = chatInput.value.trim();
        if (!message) return;

        // Afficher le message utilisateur
        appendMessage('user', message);
        chatInput.value = "";

        // Afficher le typing indicator
        const typingId = showTypingIndicator();

        const response = await fetch("@Url.Action("SendMessage", "Chat")", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message })
        });

        const data = await response.json();

        // Supprimer le typing indicator
        removeTypingIndicator(typingId);

        // Afficher la réponse du bot
        appendMessage('bot', data.reply);
    });

    // Envoi avec la touche Enter
    chatInput.addEventListener("keyup", e => {
        if (e.key === "Enter") sendBtn.click();
    });

    function appendMessage(sender, text) {
        const isBot = sender === 'bot';
        const time = getCurrentTime();

        const html = `
            <div class="message-row ${isBot ? 'bot-row' : 'user-row'}">
                ${isBot ? `<div class="message-avatar bot-avatar"><i class="bi bi-robot"></i></div>` : ''}
                <div class="message-bubble-wrapper">
                    <div class="message-bubble ${isBot ? 'bot-bubble' : 'user-bubble'}">
                        ${escapeHtml(text)}
                    </div>
                    <span class="message-time">${time}</span>
                </div>
                ${!isBot ? `<div class="message-avatar user-avatar"><i class="bi bi-person-fill"></i></div>` : ''}
            </div>
        `;

        chatBox.insertAdjacentHTML('beforeend', html);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showTypingIndicator() {
        const id = 'typing-' + Date.now();
        const html = `
            <div class="message-row bot-row" id="${id}">
                <div class="message-avatar bot-avatar"><i class="bi bi-robot"></i></div>
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;
        chatBox.insertAdjacentHTML('beforeend', html);
        chatBox.scrollTop = chatBox.scrollHeight;
        return id;
    }

    function removeTypingIndicator(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
}

@section Styles {
<style>
    .chat-wrapper {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 80px);
        max-width: 1100px;
        margin: 0 auto;
        background: #f0f2f5;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    /* Header */
    .chat-header {
        display: flex;
        align-items: center;
        gap: 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);;
        padding: 18px 28px;
        color: white;
    }

    .chat-header-avatar {
        width: 48px;
        height: 48px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #2563eb;
        font-size: 22px;
        flex-shrink: 0;
    }

    .chat-header-info h5 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
    }

    .chat-header-info span {
        font-size: 13px;
        opacity: 0.85;
    }

    /* Messages Area */
    .chat-box {
        flex: 1;
        overflow-y: auto;
        padding: 28px 32px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .chat-box::-webkit-scrollbar { width: 6px; }
    .chat-box::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
    }

    /* Message Rows */
    .message-row {
        display: flex;
        align-items: flex-end;
        gap: 12px;
    }

    .bot-row  { justify-content: flex-start; }
    .user-row { justify-content: flex-end; }

    /* Avatars */
    .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }

    .bot-avatar  { background: #e5e7eb; color: #374151; }
    .user-avatar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }

    /* Bubbles */
    .message-bubble-wrapper {
        display: flex;
        flex-direction: column;
        max-width: 60%;
    }

    .user-row .message-bubble-wrapper { align-items: flex-end; }

    .message-bubble {
        padding: 14px 18px;
        border-radius: 18px;
        font-size: 15px;
        line-height: 1.5;
        word-break: break-word;
    }

    .bot-bubble {
        background: white;
        color: #1f2937;
        border-bottom-left-radius: 4px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }

    .user-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message-time {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 5px;
        padding: 0 4px;
    }

    /* Typing Indicator */
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 14px 18px;
        background: white;
        border-radius: 18px;
        border-bottom-left-radius: 4px;
        width: fit-content;
        box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }

    .typing-indicator span {
        width: 8px;
        height: 8px;
        background: #9ca3af;
        border-radius: 50%;
        animation: typing 1.2s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @@keyframes typing {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
        30%            { transform: translateY(-6px); opacity: 1; }
    }

    /* Input Area */
    .chat-input-area {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 18px 28px;
        background: white;
        border-top: 1px solid #e5e7eb;
    }

    .chat-input {
        flex: 1;
        border: 1.5px solid #e5e7eb;
        border-radius: 10px;
        padding: 14px 18px;
        font-size: 15px;
        outline: none;
        transition: border-color 0.2s;
        background: #f9fafb;
    }

    .chat-input:focus {
        border-color: #2563eb;
        background: white;
    }

    .chat-send-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 14px 24px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s, transform 0.1s;
        white-space: nowrap;
    }

    .chat-send-btn:hover  { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .chat-send-btn:active { transform: scale(0.97); }
</style>
}